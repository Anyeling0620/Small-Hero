name: AI Architect Daily Task Generation

on:
  schedule:
    # 每天2次运行：9:00, 21:00 UTC+8（降低频率）
    - cron: '0 1 * * *'    # 09:00 UTC+8
    - cron: '0 13 * * *'   # 21:00 UTC+8
  workflow_dispatch: # 允许手动触发

# 防止同时执行多个架构师任务
concurrency:
  group: ai-architect-daily
  cancel-in-progress: false

jobs:
  architect-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 google-generativeai openai PyGithub

      - name: Check Concurrency Lock
        id: check_lock
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python scripts/utils/concurrency_lock.py || echo "lock_available=false" >> $GITHUB_OUTPUT

      - name: Scrape Game Content
        if: steps.check_lock.outputs.lock_available != 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        continue-on-error: true
        run: |
          python scripts/architect/scrape_game_content.py

      - name: Analyze Current Progress
        if: steps.check_lock.outputs.lock_available != 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        continue-on-error: true
        run: |
          python scripts/architect/analyze_progress.py

      - name: Generate Daily Tasks
        if: steps.check_lock.outputs.lock_available != 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        continue-on-error: true
        run: |
          python scripts/architect/generate_tasks.py

      - name: Commit Research Reports
        if: steps.check_lock.outputs.lock_available != 'false'
        run: |
          git config --local user.email "3463645195@qq.com"
          git config --local user.name "Anyeling0620"
          git add docs/game-research/
          git add ai-orchestrator/task-pool.json
          git diff --quiet && git diff --staged --quiet || git commit -m "[architect] Daily game research and task generation $(date +%Y-%m-%d)"
          git push

      - name: Create GitHub Issues for Tasks
        if: steps.check_lock.outputs.lock_available != 'false'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          python scripts/architect/create_task_issues.py

      - name: Send Daily Report Notification
        if: always()
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python scripts/utils/send_daily_report.py

      - name: Release Lock on Failure
        if: failure()
        run: |
          python -c "from scripts.utils.concurrency_lock import ConcurrencyLock; ConcurrencyLock().release('architect-daily')"
