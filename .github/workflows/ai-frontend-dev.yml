name: AI Frontend Development

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: number

# 使用 issue 编号作为并发组，避免同一 issue 重复执行
concurrency:
  group: frontend-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: false

jobs:
  frontend-development:
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
      LOG_DIR: .github/workflow-logs
      LOG_FILE: .github/workflow-logs/frontend-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}.log
    # 修复条件：添加检查是否已有 in-progress 标签
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (contains(github.event.issue.labels.*.name, 'frontend') && 
       !contains(github.event.issue.labels.*.name, 'in-progress'))
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Create log directory
        run: |
          mkdir -p $LOG_DIR

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python for Gemini Integration
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install requests PyGithub google-generativeai pillow openai

      - name: Add In-Progress Label
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const issue_number = parseInt(process.env.ISSUE_NUMBER)
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['in-progress']
            })

      - name: Acquire Concurrency Lock
        id: acquire_lock
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          python -c "from scripts.utils.concurrency_lock import ConcurrencyLock; import sys; lock = ConcurrencyLock(); sys.exit(0 if lock.acquire('frontend-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}', 'frontend-dev', max_wait=600) else 1)"

      - name: Parse Issue Requirements
        id: parse
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          python scripts/frontend/parse_issue.py 2>&1 | tee -a "$LOG_FILE"

      - name: Generate Assets if Needed
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          python scripts/frontend/generate_assets.py 2>&1 | tee -a "$LOG_FILE"

      - name: Generate Frontend Code
        id: generate_code
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        continue-on-error: true
        run: |
          python scripts/frontend/generate_code.py 2>&1 | tee -a "$LOG_FILE"

      - name: Retry on Failure
        if: steps.generate_code.outcome == 'failure'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          echo "⚠️  首次尝试失败，5秒后重试..." 2>&1 | tee -a "$LOG_FILE"
          sleep 5
          python scripts/frontend/generate_code.py 2>&1 | tee -a "$LOG_FILE"

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          if [ -f "package.json" ]; then
            npm install || echo "Dependencies not yet configured"
          fi

      - name: Run Linter
        run: |
          cd frontend
          if [ -f "package.json" ]; then
            npm run lint || echo "Linter not yet configured"
          fi

      - name: Build Frontend
        run: |
          cd frontend
          if [ -f "package.json" ]; then
            npm run build || echo "Build not yet configured"
          fi

      - name: Validate Code Quality
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          python scripts/frontend/validate_quality.py

      - name: Create Pull Request
        id: create_pr
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          set -e
          exec > >(tee -a "$LOG_FILE") 2>&1
          git config --local user.email "3463645195@qq.com"
          git config --local user.name "Anyeling0620"

          BRANCH_NAME="feature/frontend-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}"
          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "[frontend-dev] Implement issue #${{ github.event.issue.number || github.event.inputs.issue_number }}" || true
          git push origin $BRANCH_NAME || true

          python scripts/frontend/create_pr.py 2>&1 | tee -a "$LOG_FILE"

      - name: Send Completion Notification
        if: success()
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          python scripts/utils/send_task_complete_notification.py

      - name: Release Lock
        if: always()
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          python -c "from scripts.utils.concurrency_lock import ConcurrencyLock; ConcurrencyLock().release('frontend-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}')"

      - name: Upload workflow log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-issue-${{ env.ISSUE_NUMBER }}-log
          path: ${{ env.LOG_FILE }}

      - name: Commit workflow log to repo
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          set -e
          if [ -f "$LOG_FILE" ]; then
            git config --local user.email "3463645195@qq.com"
            git config --local user.name "Anyeling0620"
            git add $LOG_FILE || true
            git commit -m "chore: add workflow log for frontend issue #${ISSUE_NUMBER}" || echo "no changes to commit"
            git push https://${GH_PAT}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }} || echo "git push failed"
          else
            echo "No log file to commit"
          fi
